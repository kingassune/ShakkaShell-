"""Tests for CVE-to-Exploit Pipeline module.

Tests CVE lookup, Exploit-DB search, GitHub PoC search, and pipeline orchestration.
"""

import pytest
from unittest.mock import AsyncMock, patch
from datetime import datetime

from shakka.exploit import (
    CVEInfo,
    CVELookup,
    CVSSScore,
    ExploitDBResult,
    ExploitDBSearch,
    GitHubPoC,
    GitHubSearch,
    ExploitPipeline,
    ExploitResult,
    ExploitSource,
)
from shakka.exploit.cve import (
    CVEReference,
    CVSSSeverity,
    validate_cve_id,
    normalize_cve_id,
)
from shakka.exploit.exploitdb import ExploitType, Platform
from shakka.exploit.github import PoCQuality


# =============================================================================
# CVE Validation Tests
# =============================================================================

class TestCVEValidation:
    """Tests for CVE ID validation."""
    
    def test_validate_valid_cve(self):
        """Valid CVE IDs pass validation."""
        assert validate_cve_id("CVE-2024-1234") is True
        assert validate_cve_id("CVE-2023-12345") is True
        assert validate_cve_id("CVE-1999-0001") is True
        assert validate_cve_id("CVE-2024-123456") is True
    
    def test_validate_invalid_cve(self):
        """Invalid CVE IDs fail validation."""
        assert validate_cve_id("CVE-2024-123") is False  # Too short
        assert validate_cve_id("CVE2024-1234") is False   # Missing dash
        assert validate_cve_id("CVE-24-1234") is False    # Invalid year
        assert validate_cve_id("") is False
        assert validate_cve_id("not-a-cve") is False
    
    def test_validate_cve_case_insensitive(self):
        """CVE validation is case insensitive."""
        # The validation pattern is case-insensitive by design
        assert validate_cve_id("cve-2024-1234") is True
        assert validate_cve_id("Cve-2024-1234") is True
    
    def test_normalize_cve_id(self):
        """CVE IDs are normalized to uppercase."""
        assert normalize_cve_id("cve-2024-1234") == "CVE-2024-1234"
        assert normalize_cve_id("  CVE-2024-1234  ") == "CVE-2024-1234"
        assert normalize_cve_id("Cve-2024-1234") == "CVE-2024-1234"


# =============================================================================
# CVSS Score Tests
# =============================================================================

class TestCVSSScore:
    """Tests for CVSS score parsing and formatting."""
    
    def test_severity_from_score(self):
        """Severity is determined from score."""
        assert CVSSSeverity.from_score(0.0) == CVSSSeverity.NONE
        assert CVSSSeverity.from_score(3.5) == CVSSSeverity.LOW
        assert CVSSSeverity.from_score(5.5) == CVSSSeverity.MEDIUM
        assert CVSSSeverity.from_score(7.5) == CVSSSeverity.HIGH
        assert CVSSSeverity.from_score(9.5) == CVSSSeverity.CRITICAL
    
    def test_cvss_format(self):
        """CVSS score formats correctly."""
        cvss = CVSSScore(
            version="3.1",
            score=7.5,
            vector="CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
            severity=CVSSSeverity.HIGH,
        )
        formatted = cvss.format()
        assert "7.5" in formatted
        assert "HIGH" in formatted or "High" in formatted
    
    def test_cvss_to_dict(self):
        """CVSS converts to dictionary."""
        cvss = CVSSScore(
            version="3.1",
            score=9.8,
            vector="CVSS:3.1/...",
            severity=CVSSSeverity.CRITICAL,
        )
        data = cvss.to_dict()
        assert data["version"] == "3.1"
        assert data["score"] == 9.8
        assert data["severity"] == "critical"


# =============================================================================
# CVEReference Tests
# =============================================================================

class TestCVEReference:
    """Tests for CVE reference handling."""
    
    def test_is_exploit_reference(self):
        """Exploit references are detected."""
        ref = CVEReference(
            url="https://exploit-db.com/exploits/12345",
            source="exploit-db",
            tags=["exploit"],
        )
        assert ref.is_exploit is True
    
    def test_is_poc_reference(self):
        """PoC references are detected."""
        ref = CVEReference(
            url="https://github.com/user/cve-poc",
            source="github",
            tags=["third party advisory"],
        )
        assert ref.is_poc is True
    
    def test_regular_reference(self):
        """Regular references are not exploits."""
        ref = CVEReference(
            url="https://vendor.com/advisory",
            source="vendor",
            tags=["Vendor Advisory"],
        )
        assert ref.is_exploit is False


# =============================================================================
# CVEInfo Tests
# =============================================================================

class TestCVEInfo:
    """Tests for CVE information model."""
    
    def test_cve_info_creation(self):
        """CVEInfo can be created."""
        info = CVEInfo(
            cve_id="CVE-2024-1234",
            description="Test vulnerability",
        )
        assert info.cve_id == "CVE-2024-1234"
        assert info.description == "Test vulnerability"
    
    def test_cve_info_to_dict(self):
        """CVEInfo converts to dictionary."""
        info = CVEInfo(
            cve_id="CVE-2024-1234",
            description="Test vuln",
            cwe_ids=["CWE-79"],
        )
        data = info.to_dict()
        assert data["cve_id"] == "CVE-2024-1234"
        assert "CWE-79" in data["cwe_ids"]
    
    def test_cve_info_format_summary(self):
        """CVEInfo formats summary."""
        info = CVEInfo(
            cve_id="CVE-2024-1234",
            description="SQL injection in login form",
            cvss=CVSSScore(
                version="3.1",
                score=8.1,
                vector="...",
                severity=CVSSSeverity.HIGH,
            ),
        )
        summary = info.format_summary()
        assert "CVE-2024-1234" in summary
        assert "SQL injection" in summary


# =============================================================================
# CVELookup Tests
# =============================================================================

class TestCVELookup:
    """Tests for CVE lookup service."""
    
    @pytest.fixture
    def lookup(self):
        """Create CVE lookup instance."""
        return CVELookup()
    
    @pytest.mark.asyncio
    async def test_get_valid_cve(self, lookup):
        """Valid CVE returns info."""
        info = await lookup.get("CVE-2024-1234")
        assert info is not None
        assert info.cve_id == "CVE-2024-1234"
    
    @pytest.mark.asyncio
    async def test_get_invalid_cve(self, lookup):
        """Invalid CVE raises ValueError."""
        with pytest.raises(ValueError):
            await lookup.get("not-a-cve")
    
    @pytest.mark.asyncio
    async def test_get_cve_case_insensitive(self, lookup):
        """CVE lookup is case insensitive."""
        info = await lookup.get("cve-2024-5678")
        assert info is not None
        assert info.cve_id == "CVE-2024-5678"
    
    @pytest.mark.asyncio
    async def test_get_cve_cached(self, lookup):
        """CVE results are cached."""
        info1 = await lookup.get("CVE-2024-9999")
        info2 = await lookup.get("CVE-2024-9999")
        assert info1 is info2  # Same object from cache
    
    def test_clear_cache(self, lookup):
        """Cache can be cleared."""
        lookup._cache["test"] = "value"
        lookup.clear_cache()
        assert "test" not in lookup._cache


# =============================================================================
# ExploitDBResult Tests
# =============================================================================

class TestExploitDBResult:
    """Tests for Exploit-DB result model."""
    
    def test_result_creation(self):
        """Result can be created."""
        result = ExploitDBResult(
            edb_id="12345",
            title="Test Exploit",
            cve_id="CVE-2024-1234",
        )
        assert result.edb_id == "12345"
        assert result.url == "https://www.exploit-db.com/exploits/12345"
    
    def test_result_to_dict(self):
        """Result converts to dictionary."""
        result = ExploitDBResult(
            edb_id="12345",
            title="Test",
            exploit_type=ExploitType.REMOTE,
            platform=Platform.LINUX,
        )
        data = result.to_dict()
        assert data["edb_id"] == "12345"
        assert data["exploit_type"] == "remote"
        assert data["platform"] == "linux"
    
    def test_result_from_dict(self):
        """Result can be created from dict."""
        data = {
            "edb_id": "54321",
            "title": "From Dict",
            "verified": True,
        }
        result = ExploitDBResult.from_dict(data)
        assert result.edb_id == "54321"
        assert result.verified is True
    
    def test_result_format(self):
        """Result formats for display."""
        result = ExploitDBResult(
            edb_id="12345",
            title="SQL Injection",
            verified=True,
        )
        formatted = result.format()
        assert "EDB-12345" in formatted
        assert "SQL Injection" in formatted
        assert "âœ…" in formatted


# =============================================================================
# ExploitDBSearch Tests
# =============================================================================

class TestExploitDBSearch:
    """Tests for Exploit-DB search service."""
    
    @pytest.fixture
    def search(self):
        """Create search instance."""
        return ExploitDBSearch()
    
    @pytest.mark.asyncio
    async def test_search_by_cve(self, search):
        """Search by CVE returns results."""
        results = await search.search_by_cve("CVE-2024-1234")
        assert len(results) > 0
        assert results[0].cve_id == "CVE-2024-1234"
    
    @pytest.mark.asyncio
    async def test_search_by_keyword(self, search):
        """Search by keyword returns results."""
        results = await search.search_by_keyword("apache")
        assert len(results) > 0
    
    @pytest.mark.asyncio
    async def test_search_with_filters(self, search):
        """Search with filters works."""
        results = await search.search_by_keyword(
            "test",
            exploit_type=ExploitType.WEBAPPS,
            platform=Platform.LINUX,
        )
        assert len(results) > 0
    
    @pytest.mark.asyncio
    async def test_get_exploit_code(self, search):
        """Exploit code can be retrieved."""
        code = await search.get_exploit_code("12345")
        assert "Exploit-DB: 12345" in code
    
    def test_clear_cache(self, search):
        """Cache can be cleared."""
        search._cache["test"] = []
        search.clear_cache()
        assert len(search._cache) == 0


# =============================================================================
# GitHubPoC Tests
# =============================================================================

class TestGitHubPoC:
    """Tests for GitHub PoC model."""
    
    def test_poc_creation(self):
        """PoC can be created."""
        poc = GitHubPoC(
            repo_name="cve-poc",
            owner="researcher",
        )
        assert poc.url == "https://github.com/researcher/cve-poc"
        assert poc.clone_url == "https://github.com/researcher/cve-poc.git"
    
    def test_poc_to_dict(self):
        """PoC converts to dictionary."""
        poc = GitHubPoC(
            repo_name="poc",
            owner="user",
            stars=100,
            language="Python",
        )
        data = poc.to_dict()
        assert data["repo_name"] == "poc"
        assert data["stars"] == 100
    
    def test_poc_from_dict(self):
        """PoC can be created from dict."""
        data = {
            "repo_name": "test-poc",
            "owner": "tester",
            "stars": 50,
        }
        poc = GitHubPoC.from_dict(data)
        assert poc.repo_name == "test-poc"
        assert poc.stars == 50
    
    def test_poc_quality_high(self):
        """High quality PoC is detected."""
        poc = GitHubPoC(
            repo_name="popular-poc",
            owner="expert",
            stars=150,
            description="A well-documented proof of concept for testing",
            last_updated=datetime.now().isoformat(),
            language="Python",
        )
        quality = poc.assess_quality()
        assert quality == PoCQuality.HIGH
    
    def test_poc_quality_medium(self):
        """Medium quality PoC is detected."""
        poc = GitHubPoC(
            repo_name="decent-poc",
            owner="user",
            stars=25,
            description="Some description",
            last_updated=datetime.now().isoformat(),
        )
        quality = poc.assess_quality()
        assert quality == PoCQuality.MEDIUM
    
    def test_poc_quality_low(self):
        """Low quality PoC is detected."""
        poc = GitHubPoC(
            repo_name="basic-poc",
            owner="user",
            stars=2,
        )
        quality = poc.assess_quality()
        assert quality in (PoCQuality.LOW, PoCQuality.UNKNOWN)


# =============================================================================
# GitHubSearch Tests
# =============================================================================

class TestGitHubSearch:
    """Tests for GitHub search service."""
    
    @pytest.fixture
    def search(self):
        """Create search instance."""
        return GitHubSearch()
    
    @pytest.mark.asyncio
    async def test_search_by_cve(self, search):
        """Search by CVE returns results."""
        results = await search.search_by_cve("CVE-2024-1234")
        assert len(results) > 0
        assert results[0].cve_id == "CVE-2024-1234"
    
    @pytest.mark.asyncio
    async def test_search_by_keyword(self, search):
        """Search by keyword returns results."""
        results = await search.search_by_keyword("exploit")
        assert len(results) > 0
    
    @pytest.mark.asyncio
    async def test_search_sorted_by_stars(self, search):
        """Results are sorted by stars."""
        results = await search.search_by_cve("CVE-2024-5678")
        if len(results) > 1:
            assert results[0].stars >= results[-1].stars
    
    @pytest.mark.asyncio
    async def test_get_repo_files(self, search):
        """Repo files can be retrieved."""
        poc = GitHubPoC(repo_name="test", owner="user")
        files = await search.get_repo_files(poc)
        assert "exploit.py" in files
    
    @pytest.mark.asyncio
    async def test_get_file_content(self, search):
        """File content can be retrieved."""
        poc = GitHubPoC(repo_name="test", owner="user")
        content = await search.get_file_content(poc, "exploit.py")
        assert "Proof of concept" in content
    
    def test_search_with_token(self):
        """Search can use API token."""
        search = GitHubSearch(token="test-token")
        assert "Authorization" in search.headers


# =============================================================================
# ExploitResult Tests
# =============================================================================

class TestExploitResult:
    """Tests for exploit result model."""
    
    def test_result_creation(self):
        """Result can be created."""
        result = ExploitResult(
            cve_id="CVE-2024-1234",
            source=ExploitSource.EXPLOIT_DB,
            title="Test Exploit",
        )
        assert result.cve_id == "CVE-2024-1234"
        assert result.source == ExploitSource.EXPLOIT_DB
    
    def test_result_to_dict(self):
        """Result converts to dictionary."""
        result = ExploitResult(
            cve_id="CVE-2024-1234",
            source=ExploitSource.GITHUB,
            title="GitHub PoC",
            confidence=0.8,
        )
        data = result.to_dict()
        assert data["source"] == "github"
        assert data["confidence"] == 0.8
    
    def test_result_from_dict(self):
        """Result can be created from dict."""
        data = {
            "cve_id": "CVE-2024-5678",
            "source": "nvd",
            "title": "NVD Info",
            "verified": True,
        }
        result = ExploitResult.from_dict(data)
        assert result.source == ExploitSource.NVD
        assert result.verified is True
    
    def test_result_format(self):
        """Result formats for display."""
        result = ExploitResult(
            cve_id="CVE-2024-1234",
            source=ExploitSource.EXPLOIT_DB,
            title="SQL Injection Exploit",
            verified=True,
            confidence=0.9,
        )
        formatted = result.format()
        assert "CVE-2024-1234" in formatted
        assert "90%" in formatted
        assert "Verified" in formatted


# =============================================================================
# ExploitPipeline Tests
# =============================================================================

class TestExploitPipeline:
    """Tests for exploit pipeline orchestration."""
    
    @pytest.fixture
    def pipeline(self):
        """Create pipeline instance."""
        return ExploitPipeline()
    
    @pytest.mark.asyncio
    async def test_search_valid_cve(self, pipeline):
        """Pipeline search returns results."""
        results = await pipeline.search("CVE-2024-1234")
        assert len(results) > 0
    
    @pytest.mark.asyncio
    async def test_search_invalid_cve(self, pipeline):
        """Invalid CVE returns empty."""
        results = await pipeline.search("not-a-cve")
        assert len(results) == 0
    
    @pytest.mark.asyncio
    async def test_search_specific_sources(self, pipeline):
        """Pipeline can search specific sources."""
        results = await pipeline.search(
            "CVE-2024-1234",
            sources=[ExploitSource.EXPLOIT_DB],
        )
        assert len(results) > 0
        for r in results:
            assert r.source == ExploitSource.EXPLOIT_DB
    
    @pytest.mark.asyncio
    async def test_search_sorted_by_confidence(self, pipeline):
        """Results are sorted by confidence."""
        results = await pipeline.search("CVE-2024-5678")
        if len(results) > 1:
            assert results[0].confidence >= results[-1].confidence
    
    @pytest.mark.asyncio
    async def test_search_with_safety_checks(self, pipeline):
        """Safety checks are applied."""
        results = await pipeline.search("CVE-2024-1234")
        for r in results:
            assert hasattr(r, "safe_for_testing")
    
    @pytest.mark.asyncio
    async def test_search_without_safety_checks(self):
        """Safety checks can be disabled."""
        pipeline = ExploitPipeline(safety_check=False)
        results = await pipeline.search("CVE-2024-1234")
        assert len(results) > 0
    
    @pytest.mark.asyncio
    async def test_search_without_llm(self):
        """LLM synthesis can be disabled."""
        pipeline = ExploitPipeline(enable_llm_synthesis=False)
        results = await pipeline.search("CVE-2024-1234")
        for r in results:
            assert r.source != ExploitSource.LLM
    
    @pytest.mark.asyncio
    async def test_get_exploit_code(self, pipeline):
        """Exploit code can be retrieved."""
        code = await pipeline.get_exploit_code("CVE-2024-1234")
        assert code is not None
        assert len(code) > 0
    
    @pytest.mark.asyncio
    async def test_get_exploit_code_preferred_source(self, pipeline):
        """Preferred source is used."""
        code = await pipeline.get_exploit_code(
            "CVE-2024-1234",
            prefer_source=ExploitSource.EXPLOIT_DB,
        )
        assert code is not None
    
    @pytest.mark.asyncio
    async def test_search_cached(self, pipeline):
        """Results are cached."""
        results1 = await pipeline.search("CVE-2024-9999")
        results2 = await pipeline.search("CVE-2024-9999")
        assert results1 is results2
    
    def test_clear_cache(self, pipeline):
        """All caches can be cleared."""
        pipeline._cache["test"] = []
        pipeline.clear_cache()
        assert len(pipeline._cache) == 0


# =============================================================================
# Integration Tests
# =============================================================================

class TestExploitPipelineIntegration:
    """Integration tests for exploit pipeline."""
    
    @pytest.mark.asyncio
    async def test_full_pipeline_flow(self):
        """Full pipeline flow works end-to-end."""
        pipeline = ExploitPipeline()
        
        # Search for CVE
        results = await pipeline.search("CVE-2024-1234")
        assert len(results) > 0
        
        # Check result properties
        result = results[0]
        assert result.cve_id == "CVE-2024-1234"
        assert result.source in list(ExploitSource)
        
        # Get exploit code
        code = await pipeline.get_exploit_code("CVE-2024-1234")
        assert code is not None
    
    @pytest.mark.asyncio
    async def test_pipeline_with_all_sources(self):
        """Pipeline aggregates from all sources."""
        pipeline = ExploitPipeline(enable_llm_synthesis=True)
        
        results = await pipeline.search(
            "CVE-2024-1234",
            sources=[
                ExploitSource.NVD,
                ExploitSource.EXPLOIT_DB,
                ExploitSource.GITHUB,
                ExploitSource.LLM,
            ],
        )
        
        sources = {r.source for r in results}
        assert len(sources) >= 1  # At least one source
    
    @pytest.mark.asyncio
    async def test_safety_detection(self):
        """Dangerous patterns are detected."""
        pipeline = ExploitPipeline()
        
        # Create mock result with dangerous code
        result = ExploitResult(
            cve_id="CVE-2024-TEST",
            source=ExploitSource.LLM,
            title="Dangerous",
            code="rm -rf /",
        )
        
        is_safe = pipeline._is_safe_for_testing(result)
        assert is_safe is False


# =============================================================================
# ExploitSource Tests
# =============================================================================

class TestExploitSource:
    """Tests for exploit source enum."""
    
    def test_source_values(self):
        """All source values exist."""
        assert ExploitSource.NVD.value == "nvd"
        assert ExploitSource.EXPLOIT_DB.value == "exploit_db"
        assert ExploitSource.GITHUB.value == "github"
        assert ExploitSource.NUCLEI.value == "nuclei"
        assert ExploitSource.LLM.value == "llm"


# =============================================================================
# Edge Cases
# =============================================================================

class TestEdgeCases:
    """Tests for edge cases and error handling."""
    
    @pytest.mark.asyncio
    async def test_empty_cve_id(self):
        """Empty CVE ID is handled."""
        pipeline = ExploitPipeline()
        results = await pipeline.search("")
        assert results == []
    
    @pytest.mark.asyncio
    async def test_whitespace_cve_id(self):
        """Whitespace CVE ID is handled."""
        pipeline = ExploitPipeline()
        results = await pipeline.search("   CVE-2024-1234   ")
        assert len(results) > 0
    
    @pytest.mark.asyncio
    async def test_lowercase_cve_id(self):
        """Lowercase CVE ID is handled."""
        pipeline = ExploitPipeline()
        results = await pipeline.search("cve-2024-1234")
        assert len(results) > 0
        assert results[0].cve_id == "CVE-2024-1234"
    
    def test_exploit_type_enum(self):
        """ExploitType enum works."""
        assert ExploitType.WEBAPPS.value == "webapps"
        assert ExploitType.REMOTE.value == "remote"
        assert ExploitType.LOCAL.value == "local"
    
    def test_platform_enum(self):
        """Platform enum works."""
        assert Platform.LINUX.value == "linux"
        assert Platform.WINDOWS.value == "windows"
        assert Platform.MULTIPLE.value == "multiple"
    
    def test_poc_quality_enum(self):
        """PoCQuality enum works."""
        assert PoCQuality.HIGH.value == "high"
        assert PoCQuality.MEDIUM.value == "medium"
        assert PoCQuality.LOW.value == "low"
        assert PoCQuality.UNKNOWN.value == "unknown"
